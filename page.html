<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Yfitops — Écoutez de la musique partout</title>
  <meta name="description" content="Yfitops, un clone accessible de Spotify en HTML/CSS/JS (WCAG AA), responsive, sans dépendances." />
  <meta name="theme-color" content="#0f172a" />
  <style>
    /* ======= Design tokens (high contrast) ======= */
    :root {
      --bg: #0b1020;            /* slate-950-ish */
      --panel: #111828;         /* slate-900 */
      --muted: #9aa3b2;         /* slate-400 */
      --text: #eef2ff;          /* indigo-50 */
      --accent: #22c55e;        /* green-500 */
      --accent-2: #60a5fa;      /* blue-400 */
      --danger: #ef4444;        /* red-500 */
      --focus: #fde047;         /* yellow-300 */
      --border: #1f2937;        /* slate-800 */
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
      --radius-sm: 12px;
      --trans: 160ms ease;
    }

    [data-theme="light"] {
      --bg: #f4f5f7;
      --panel: #ffffff;
      --muted: #4b5563;
      --text: #0b1020;
      --accent: #16a34a;
      --accent-2: #2563eb;
      --danger: #dc2626;
      --focus: #ca8a04;
      --border: #e5e7eb;
      --shadow: 0 10px 30px rgba(0,0,0,.08);
    }

    /* ======= Base ======= */
    html, body { height: 100%; }
    body {
      margin: 0;
      color: var(--text);
      background: var(--bg);
      font: 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }

    a, button { cursor: pointer; }
    :focus-visible { outline: 3px solid var(--focus); outline-offset: 2px; border-radius: 6px; }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce) {
      * { animation: none !important; transition: none !important; scroll-behavior: auto !important; }
    }

    /* ======= App layout ======= */
    .app {
      display: grid;
      grid-template-columns: 280px 1fr;
      grid-template-rows: auto 1fr auto; /* header, main, player */
      grid-template-areas:
        "sidebar header"
        "sidebar main"
        "player player";
      height: 100dvh; /* mobile safe */
    }

    header {
      grid-area: header;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: var(--panel);
      box-shadow: var(--shadow);
      z-index: 3;
    }

    .brand { display: flex; align-items: center; gap: 10px; margin-right: auto; }
    .brand svg { width: 28px; height: 28px; }
    .brand-name { font-weight: 800; letter-spacing: .5px; }

    .search {
      position: relative;
      flex: 1 1 420px;
      max-width: 680px;
    }
    .search input {
      width: 100%;
      padding: 12px 44px 12px 14px;
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: var(--radius);
    }
    .search .icon { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); }

    .header-actions { display: flex; align-items: center; gap: 8px; }
    .btn {
      display: inline-flex; align-items: center; gap: 8px; justify-content: center;
      padding: 10px 14px; border-radius: var(--radius-sm);
      border: 1px solid var(--border); background: var(--panel); color: var(--text);
      transition: transform var(--trans), background var(--trans), border-color var(--trans);
    }
    .btn:hover { transform: translateY(-1px); border-color: var(--muted); }
    .btn.primary { background: linear-gradient(180deg, var(--accent), #1b9a51); color: #07150c; border: none; }

    nav.sidebar {
      grid-area: sidebar;
      display: flex; flex-direction: column; gap: 12px;
      background: var(--panel);
      border-right: 1px solid var(--border);
      padding: 16px;
      overflow-y: auto;
    }
    .nav-section { margin-bottom: 10px; }
    .nav-title { font-size: 12px; text-transform: uppercase; color: var(--muted); letter-spacing: .12em; padding: 8px 8px; }
    .nav-link { display: flex; align-items: center; gap: 12px; padding: 10px 12px; border-radius: 12px; color: var(--text); text-decoration: none; border: 1px solid transparent; }
    .nav-link[aria-current="page"], .nav-link:hover { background: var(--bg); border-color: var(--border); }

    main {
      grid-area: main;
      overflow: auto;
      padding: 20px;
      display: grid;
      gap: 20px;
      grid-template-columns: 1fr;
    }

    .section { background: var(--panel); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; box-shadow: var(--shadow); }
    .section h2 { margin: 0 0 12px; font-size: 18px; }

    .cards { display: grid; gap: 12px; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); }
    .card {
      background: var(--bg); border: 1px solid var(--border); border-radius: 16px; overflow: hidden; display: flex; flex-direction: column;
      transition: transform var(--trans), border-color var(--trans);
    }
    .card:hover { transform: translateY(-2px); border-color: var(--muted); }
    .cover { aspect-ratio: 1 / 1; display: grid; place-items: center; }
    .cover svg { width: 60%; height: 60%; }
    .card .meta { padding: 12px; display: grid; gap: 6px; }
    .card .title { font-weight: 700; }
    .card .subtitle { font-size: 13px; color: var(--muted); }
    .card .actions { margin-top: 8px; display: flex; gap: 8px; }

    /* Player */
    .player {
      grid-area: player;
      display: grid; grid-template-columns: 360px 1fr 360px; align-items: center; gap: 16px;
      padding: 10px 16px; background: var(--panel); border-top: 1px solid var(--border); box-shadow: var(--shadow);
      position: sticky; bottom: 0; z-index: 10;
    }
    .now { display: flex; align-items: center; gap: 12px; min-width: 0; }
    .now .track-text { min-width: 0; }
    .ellipsis { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .controls { display: flex; flex-direction: column; align-items: center; gap: 6px; }
    .transport { display: flex; align-items: center; gap: 10px; }
    .icon-btn { border: 1px solid var(--border); background: var(--bg); border-radius: 999px; width: 36px; height: 36px; display: grid; place-items: center; transition: all var(--trans); }
    .icon-btn:hover { transform: scale(1.05); border-color: var(--muted); }
    .icon-btn[aria-pressed="true"] { background: var(--accent-2); color: white; }

    .progress { display: grid; grid-template-columns: auto 1fr auto; align-items: center; gap: 8px; width: min(700px, 90%); }
    input[type="range"] { 
      width: 100%; height: 6px; accent-color: var(--accent); 
      -webkit-appearance: none; appearance: none; background: var(--border); border-radius: 3px;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none; appearance: none; width: 16px; height: 16px; border-radius: 50%;
      background: var(--accent); cursor: pointer;
    }
    input[type="range"]::-moz-range-thumb {
      width: 16px; height: 16px; border-radius: 50%; background: var(--accent); cursor: pointer; border: none;
    }

    .right { display: flex; align-items: center; gap: 8px; justify-content: flex-end; }

    /* Upload area */
    .drop {
      border: 2px dashed var(--border); border-radius: var(--radius);
      padding: 16px; color: var(--muted); text-align: center; cursor: pointer;
      transition: border-color var(--trans);
    }
    .drop:hover { border-color: var(--accent-2); }
    .drop[aria-busy="true"] { opacity: .6; }

    /* ======= Responsive ======= */
    @media (max-width: 1000px) {
      .app { grid-template-columns: 84px 1fr; }
      .nav-title { display: none; }
      .nav-link span { display: none; }
    }

    @media (max-width: 760px) {
      header { position: sticky; top: 0; }
      .search { flex-basis: auto; }
      .player { grid-template-columns: 1fr; gap: 6px; }
      .now { justify-content: center; }
      .right { justify-content: center; }
    }
  </style>
</head>
<body>
  <a href="#main" class="sr-only" id="skip-link">Aller au contenu</a>

  <div class="app" data-theme="dark">
    <nav class="sidebar" aria-label="Navigation principale">
      <div class="nav-section">
        <div class="nav-title">Yfitops</div>
        <a class="nav-link" href="#home" aria-current="page">
          <svg aria-hidden="true" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M3 9.75 12 3l9 6.75V21a1.5 1.5 0 0 1-1.5 1.5H4.5A1.5 1.5 0 0 1 3 21V9.75Z"/></svg>
          <span>Accueil</span>
        </a>
        <a class="nav-link" href="#search">
          <svg aria-hidden="true" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M10 18a8 8 0 1 1 6.32-3.1l4.39 4.39-1.41 1.41-4.39-4.39A8 8 0 0 1 10 18Z"/></svg>
          <span>Rechercher</span>
        </a>
        <a class="nav-link" href="#library">
          <svg aria-hidden="true" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M4 4h4v16H4zM10 4h4v16h-4zM16 4h4v16h-4z"/></svg>
          <span>Bibliothèque</span>
        </a>
      </div>
      <div class="nav-section">
        <div class="nav-title">Playlists</div>
        <a class="nav-link" href="#picks"><svg aria-hidden="true" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M4 6h16v2H4zm0 5h16v2H4zm0 5h10v2H4z"/></svg><span>Coups de cœur</span></a>
        <a class="nav-link" href="#focus"><svg aria-hidden="true" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2 2 7l10 5 10-5-10-5zm0 7-10 5 10 5 10-5-10-5z"/></svg><span>Focus</span></a>
      </div>
    </nav>

    <header role="banner">
      <div class="brand" aria-label="Yfitops, aller à l'accueil">
        <svg aria-hidden="true" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a10 10 0 1 0 10 10A10.011 10.011 0 0 0 12 2Zm4.95 14.536a1 1 0 0 1-1.415.05 9.16 9.16 0 0 0-2.86-1.79 14.89 14.89 0 0 0-3.63-.896 1 1 0 0 1 .274-1.986 16.943 16.943 0 0 1 4.15 1.02 11.129 11.129 0 0 1 3.47 2.173 1 1 0 0 1 .01 1.43ZM17 11a1 1 0 0 1-1.707.707 9.631 9.631 0 0 0-2.147-1.434 13.676 13.676 0 0 0-3.646-1.105 1 1 0 1 1 .36-1.966 15.5 15.5 0 0 1 4.073 1.233A11.542 11.542 0 0 1 17 11Zm.5-3a1 1 0 0 1-1.707.707A12.3 12.3 0 0 0 13 7.17a1 1 0 1 1 .5-1.936 14.25 14.25 0 0 1 3.086 1.652A1 1 0 0 1 17.5 8Z"/></svg>
        <strong class="brand-name" aria-hidden="true">Yfitops</strong>
      </div>

      <form class="search" role="search" aria-label="Rechercher des morceaux ou artistes">
        <label class="sr-only" for="q">Recherche</label>
        <input id="q" name="q" type="search" placeholder="Rechercher… (Alt+/)" autocomplete="off" />
        <span class="icon" aria-hidden="true">⌘K</span>
      </form>

      <div class="header-actions">
        <button id="themeBtn" class="btn" type="button" aria-pressed="false" aria-label="Basculer le thème">🌙</button>
        <button id="loginBtn" class="btn primary" type="button">Se connecter</button>
      </div>
    </header>

    <main id="main" role="main">
      <section class="section" aria-labelledby="s-hero">
        <h2 id="s-hero">À la une</h2>
        <div class="cards" id="heroCards" role="list"></div>
      </section>

      <section class="section" aria-labelledby="s-pop">
        <h2 id="s-pop">Playlists populaires</h2>
        <div class="cards" id="popCards" role="list"></div>
      </section>

      <section class="section" aria-labelledby="s-upload">
        <h2 id="s-upload">Votre musique</h2>
        <div class="drop" id="drop" role="region" aria-label="Déposer des fichiers audio ici" tabindex="0">
          Glissez-déposez des fichiers .mp3/.wav ici ou <label for="file" style="text-decoration: underline; cursor: pointer;">cliquez pour sélectionner</label>.
          <input id="file" type="file" accept="audio/*" multiple class="sr-only" />
        </div>
        <div id="userTracks" class="cards" role="list" aria-label="Titres importés"></div>
      </section>
    </main>

    <!-- Player -->
    <div class="player" role="region" aria-label="Lecteur audio" data-state="paused">
      <div class="now">
        <div class="cover" aria-hidden="true" style="width:56px;height:56px;background:var(--bg);border:1px solid var(--border);border-radius:12px;display:grid;place-items:center;">
          <svg viewBox="0 0 24 24" fill="currentColor" width="28" height="28"><path d="M12 2a10 10 0 1 0 10 10A10.011 10.011 0 0 0 12 2Z"/><path d="M9 8l8 4-8 4z" fill="#22c55e"/></svg>
        </div>
        <div class="track-text">
          <div id="nowTitle" class="ellipsis" aria-live="polite">Aucun titre</div>
          <div id="nowArtist" class="ellipsis" aria-live="polite" style="color:var(--muted)">—</div>
        </div>
      </div>

      <div class="controls">
        <div class="transport">
          <button class="icon-btn" id="shuffleBtn" type="button" aria-pressed="false" aria-label="Activer le mode aléatoire">🔀</button>
          <button class="icon-btn" id="prevBtn" type="button" aria-label="Piste précédente">⏮</button>
          <button class="icon-btn" id="playBtn" type="button" aria-label="Lecture (Espace)">▶️</button>
          <button class="icon-btn" id="nextBtn" type="button" aria-label="Piste suivante">⏭</button>
          <button class="icon-btn" id="repeatBtn" type="button" aria-pressed="false" aria-label="Activer la répétition">🔁</button>
        </div>
        <div class="progress">
          <span id="currentTime" aria-live="off" style="font-variant-numeric: tabular-nums;">0:00</span>
          <input id="seek" type="range" min="0" max="100" value="0" step="1" aria-label="Position de lecture" />
          <span id="duration" aria-live="polite" style="font-variant-numeric: tabular-nums;">0:00</span>
        </div>
      </div>

      <div class="right">
        <button class="icon-btn" id="muteBtn" type="button" aria-pressed="false" aria-label="Muet">🔈</button>
        <label for="vol" class="sr-only">Volume</label>
        <input id="vol" type="range" min="0" max="1" step="0.01" value="0.8" aria-label="Volume" style="width: 80px;" />
        <div id="a11yLog" class="sr-only" aria-live="polite"></div>
      </div>

      <audio id="audio" preload="metadata"></audio>
    </div>
  </div>

  <script>
    // ======= Helpers & State =======
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    const state = {
      theme: 'dark',
      queue: [],         // { id, title, artist, src, cover, duration }
      current: -1,
      repeat: false,
      shuffle: false,
    };

    function saveTheme() {
      try { localStorage.setItem('yfitops-theme', state.theme); } catch {}
    }
    function loadTheme() {
      try { return localStorage.getItem('yfitops-theme') || 'dark'; } catch { return 'dark'; }
    }

    function formatTime(t) {
      if (!isFinite(t) || t < 0) t = 0;
      const m = Math.floor(t / 60);
      const s = Math.floor(t % 60);
      return m + ':' + String(s).padStart(2, '0');
    }

    function announce(msg) { const log = $('#a11yLog'); log.textContent = msg; }

    // ======= Tone generator (creates a small WAV so the player works out-of-the-box) =======
    function createSineWaveBlob(seconds = 2, freq = 440, sampleRate = 44100) {
      const length = seconds * sampleRate;
      const headerSize = 44;
      const buffer = new ArrayBuffer(headerSize + length * 2);
      const view = new DataView(buffer);

      // Write WAV header (PCM 16-bit mono)
      function writeString(offset, str) { for (let i=0; i<str.length; i++) view.setUint8(offset+i, str.charCodeAt(i)); }
      function write16(offset, value) { view.setUint16(offset, value, true); }
      function write32(offset, value) { view.setUint32(offset, value, true); }

      writeString(0, 'RIFF');
      write32(4, 36 + length * 2);
      writeString(8, 'WAVE');
      writeString(12, 'fmt ');
      write32(16, 16);              // PCM chunk size
      write16(20, 1);               // Audio format 1=PCM
      write16(22, 1);               // channels
      write32(24, sampleRate);
      write32(28, sampleRate * 2);  // byte rate
      write16(32, 2);               // block align
      write16(34, 16);              // bits per sample
      writeString(36, 'data');
      write32(40, length * 2);

      // PCM data
      let offset = 44;
      for (let i = 0; i < length; i++) {
        const t = i / sampleRate;
        const sample = Math.sin(2 * Math.PI * freq * t) * 0.3; // -10 dBFS approx
        const s = Math.max(-1, Math.min(1, sample));
        view.setInt16(offset, s * 0x7fff, true);
        offset += 2;
      }

      return new Blob([buffer], { type: 'audio/wav' });
    }

    // ======= Mock catalog =======
    const demoBlob = createSineWaveBlob(3, 494); // 3s note (B4)
    const demoURL = URL.createObjectURL(demoBlob);
    const CATALOG = [
      { id: 'd1', title: 'Première Onde', artist: 'Synthèse', src: demoURL },
      { id: 'd2', title: 'Impulsion', artist: 'Yfitops Lab', src: demoURL },
      { id: 'd3', title: 'Éther', artist: 'Nocturne', src: demoURL },
      { id: 'd4', title: 'Tessiture', artist: 'Contours', src: demoURL },
      { id: 'd5', title: 'Aurore', artist: 'Horizon', src: demoURL },
      { id: 'd6', title: 'Resonance', artist: 'Echo Studio', src: demoURL },
      { id: 'd7', title: 'Vibration', artist: 'Wave Collective', src: demoURL }
    ];

    // ======= UI Bootstrap =======
    function cardTemplate(track) {
      return `
        <article class="card" role="listitem">
          <div class="cover" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="10"/><path d="M9 8l8 4-8 4z" fill="#22c55e"/></svg>
          </div>
          <div class="meta">
            <div class="title ellipsis" title="${track.title}">${track.title}</div>
            <div class="subtitle ellipsis" title="${track.artist}">${track.artist}</div>
            <div class="actions">
              <button class="btn" data-action="play" data-id="${track.id}" aria-label="Lire ${track.title} par ${track.artist}">Lire</button>
              <button class="btn" data-action="queue" data-id="${track.id}" aria-label="Ajouter ${track.title} à la file d'attente">+ File</button>
            </div>
          </div>
        </article>`;
    }

    function renderSections() {
      $('#heroCards').innerHTML = CATALOG.slice(0, 4).map(cardTemplate).join('');
      $('#popCards').innerHTML = CATALOG.slice().reverse().map(cardTemplate).join('');
    }

    // ======= Player Logic =======
    const audio = $('#audio');
    const playBtn = $('#playBtn');
    const prevBtn = $('#prevBtn');
    const nextBtn = $('#nextBtn');
    const repeatBtn = $('#repeatBtn');
    const shuffleBtn = $('#shuffleBtn');
    const muteBtn = $('#muteBtn');
    const seek = $('#seek');
    const vol = $('#vol');
    const nowTitle = $('#nowTitle');
    const nowArtist = $('#nowArtist');
    const currentTimeEl = $('#currentTime');
    const durationEl = $('#duration');

    function setQueue(list) { state.queue = list.slice(); }
    setQueue(CATALOG);

    function load(index) {
      if (index < 0 || index >= state.queue.length) return;
      state.current = index;
      const t = state.queue[index];
      audio.src = t.src;
      nowTitle.textContent = t.title;
      nowArtist.textContent = t.artist;
      document.title = `${t.title} • ${t.artist} — Yfitops`;
      announce(`Chargé: ${t.title} par ${t.artist}`);
    }

    function play() {
      if (!audio.src) load(0);
      audio.play().then(() => {
        $('.player').dataset.state = 'playing';
        playBtn.textContent = '⏸';
        playBtn.setAttribute('aria-label', 'Pause (Espace)');
        announce('Lecture');
      }).catch(err => {
        console.log('Erreur de lecture:', err);
        announce('Erreur de lecture');
      });
    }

    function pause() {
      audio.pause();
      $('.player').dataset.state = 'paused';
      playBtn.textContent = '▶️';
      playBtn.setAttribute('aria-label', 'Lecture (Espace)');
      announce('Pause');
    }

    function togglePlay() { audio.paused ? play() : pause(); }
    
    function prev() { 
      if (state.queue.length) { 
        const i = state.current > 0 ? state.current - 1 : state.queue.length - 1; 
        load(i); 
        if (!audio.paused) play(); 
      } 
    }
    
    function next(auto=false) {
      if (!state.queue.length) return;
      let i = state.current + 1;
      if (state.shuffle) i = Math.floor(Math.random() * state.queue.length);
      if (i >= state.queue.length) i = 0;
      if (auto && state.repeat) i = state.current; // repeat current
      load(i); 
      if (!audio.paused || auto) play();
    }

    function setRepeat(v) { 
      state.repeat = v; 
      repeatBtn.setAttribute('aria-pressed', String(v)); 
      repeatBtn.style.background = v ? 'var(--accent-2)' : 'var(--bg)';
      announce(v ? 'Répétition activée' : 'Répétition désactivée'); 
    }
    
    function setShuffle(v) { 
      state.shuffle = v; 
      shuffleBtn.setAttribute('aria-pressed', String(v)); 
      shuffleBtn.style.background = v ? 'var(--accent-2)' : 'var(--bg)';
      announce(v ? 'Aléatoire activé' : 'Aléatoire désactivé'); 
    }

    // Events
    playBtn.addEventListener('click', togglePlay);
    prevBtn.addEventListener('click', prev);
    nextBtn.addEventListener('click', () => next(false));
    repeatBtn.addEventListener('click', () => setRepeat(!state.repeat));
    shuffleBtn.addEventListener('click', () => setShuffle(!state.shuffle));

    muteBtn.addEventListener('click', () => {
      audio.muted = !audio.muted;
      muteBtn.setAttribute('aria-pressed', String(audio.muted));
      muteBtn.textContent = audio.muted ? '🔇' : '🔈';
      muteBtn.style.background = audio.muted ? 'var(--danger)' : 'var(--bg)';
      announce(audio.muted ? 'Son coupé' : 'Son rétabli');
    });

    vol.addEventListener('input', () => { 
      audio.volume = parseFloat(vol.value); 
      announce(`Volume: ${Math.round(audio.volume * 100)}%`);
    });

    audio.addEventListener('timeupdate', () => {
      currentTimeEl.textContent = formatTime(audio.currentTime);
      seek.value = audio.duration ? Math.round((audio.currentTime / audio.duration) * 100) : 0;
    });

    audio.addEventListener('loadedmetadata', () => {
      durationEl.textContent = formatTime(audio.duration);
      seek.max = 100;
    });

    audio.addEventListener('ended', () => {
      if (state.repeat) {
        audio.currentTime = 0;
        play();
      } else {
        next(true);
      }
    });

    let seeking = false;
    seek.addEventListener('mousedown', () => { seeking = true; });
    seek.addEventListener('mouseup', () => { seeking = false; });
    seek.addEventListener('input', () => {
      if (!audio.duration || seeking) return;
      const pct = parseFloat(seek.value) / 100;
      audio.currentTime = pct * audio.duration;
    });

    // Keyboard shortcuts (WCAG: ensure they don't conflict & are discoverable)
    document.addEventListener('keydown', (e) => {
      if (e.target.tagName === 'INPUT' && e.target.type !== 'range') return;
      
      if (e.key === ' ') { 
        e.preventDefault(); 
        togglePlay(); 
      }
      if ((e.altKey || e.metaKey) && e.key === '/') { 
        e.preventDefault(); 
        $('#q').focus(); 
      }
      if (e.key === 'ArrowRight' && audio.duration) { 
        e.preventDefault();
        audio.currentTime = Math.min(audio.duration, audio.currentTime + 5); 
      }
      if (e.key === 'ArrowLeft' && audio.duration) { 
        e.preventDefault();
        audio.currentTime = Math.max(0, audio.currentTime - 5); 
      }
      if (e.key === 'ArrowUp') {
        e.preventDefault();
        vol.value = Math.min(1, parseFloat(vol.value) + 0.1);
        audio.volume = parseFloat(vol.value);
        announce(`Volume: ${Math.round(audio.volume * 100)}%`);
      }
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        vol.value = Math.max(0, parseFloat(vol.value) - 0.1);
        audio.volume = parseFloat(vol.value);
        announce(`Volume: ${Math.round(audio.volume * 100)}%`);
      }
    }, { passive: false });

    // Delegate play/queue buttons
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-action]');
      if (!btn) return;
      const id = btn.getAttribute('data-id');
      const idx = state.queue.findIndex(t => t.id === id);
      if (btn.dataset.action === 'play') { 
        if (idx !== -1) { 
          load(idx); 
          play(); 
        } 
      }
      if (btn.dataset.action === 'queue') { 
        announce('Ajouté à la file: ' + (state.queue[idx]?.title || 'Titre')); 
      }
    });

    // Upload / Drag & Drop
    const drop = $('#drop');
    const fileInput = $('#file');
    
    drop.addEventListener('dragover', (e) => { 
      e.preventDefault(); 
      drop.style.borderColor = 'var(--accent-2)'; 
    });
    
    drop.addEventListener('dragleave', () => { 
      drop.style.borderColor = 'var(--border)'; 
    });
    
    drop.addEventListener('drop', (e) => { 
      e.preventDefault(); 
      drop.style.borderColor = 'var(--border)'; 
      handleFiles(e.dataTransfer.files); 
    });
    
    drop.addEventListener('click', (e) => {
      if (e.target.tagName !== 'INPUT') {
        fileInput.click();
      }
    });
    
    drop.addEventListener('keydown', (e) => { 
      if (e.key === 'Enter' || e.key === ' ') { 
        e.preventDefault(); 
        fileInput.click(); 
      } 
    });
    
    fileInput.addEventListener('change', () => handleFiles(fileInput.files));

    function handleFiles(files) {
      if (!files || !files.length) return;
      drop.setAttribute('aria-busy', 'true');
      
      const newTracks = [];
      Array.from(files).forEach((f, i) => {
        if (f.type.startsWith('audio/')) {
          const url = URL.createObjectURL(f);
          const base = f.name.replace(/\.[^.]+$/, '');
          newTracks.push({ 
            id: 'u' + Date.now() + '-' + i, 
            title: base, 
            artist: 'Importé', 
            src: url 
          });
        }
      });
      
      if (newTracks.length > 0) {
        // Render cards
        const container = $('#userTracks');
        container.insertAdjacentHTML('beforeend', newTracks.map(cardTemplate).join(''));
        
        // Add to queue
        state.queue.push(...newTracks);
        
        announce(newTracks.length + ' fichier(s) importé(s)');
      } else {
        announce('Aucun fichier audio valide trouvé');
      }
      
      drop.setAttribute('aria-busy', 'false');
      fileInput.value = '';
    }

    // Theme switch
    const themeBtn = $('#themeBtn');
    
    function applyTheme(t) { 
      document.querySelector('.app').setAttribute('data-theme', t); 
      themeBtn.setAttribute('aria-pressed', String(t==='dark')); 
      themeBtn.textContent = t === 'dark' ? '☀️' : '🌙';
      themeBtn.setAttribute('aria-label', t === 'dark' ? 'Passer au thème clair' : 'Passer au thème sombre');
    }
    
    state.theme = loadTheme();
    applyTheme(state.theme);
    
    themeBtn.addEventListener('click', () => { 
      state.theme = state.theme === 'dark' ? 'light' : 'dark'; 
      applyTheme(state.theme); 
      saveTheme(); 
      announce(`Thème ${state.theme === 'dark' ? 'sombre' : 'clair'} activé`);
    });

    // Search functionality
    const searchInput = $('#q');
    searchInput.addEventListener('input', (e) => {
      const query = e.target.value.toLowerCase().trim();
      if (query.length === 0) {
        renderSections();
        return;
      }
      
      const filtered = CATALOG.filter(track => 
        track.title.toLowerCase().includes(query) || 
        track.artist.toLowerCase().includes(query)
      );
      
      $('#heroCards').innerHTML = filtered.slice(0, 4).map(cardTemplate).join('');
      $('#popCards').innerHTML = filtered.slice(4).map(cardTemplate).join('');
      
      if (filtered.length === 0) {
        $('#heroCards').innerHTML = '<p style="color: var(--muted); text-align: center; grid-column: 1/-1;">Aucun résultat trouvé</p>';
        $('#popCards').innerHTML = '';
      }
    });

    // Init
    renderSections();
    load(0); // Preload first track
    audio.volume = 0.8;

    // Respect prefers-reduced-motion for focus scrolls
    document.getElementById('skip-link').addEventListener('click', (e) => {
      e.preventDefault();
      document.getElementById('main').focus({ preventScroll: false });
    });

    // Login button
    $('#loginBtn').addEventListener('click', () => {
      announce('Fonctionnalité de connexion non implémentée');
    });

    console.log('🎵 Yfitops Player initialisé!');
  </script>
</body>
</html>